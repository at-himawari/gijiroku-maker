# テスト最適化ガイド

## 実施した最適化

### 1. プロパティベーステストの実行回数削減

- `numRuns` を 10-20 から 2-3 に削減
- テスト時間を大幅に短縮

### 2. Jest 設定の最適化

- `maxWorkers: 2` - ワーカー数を制限
- `testTimeout: 15000` - デフォルトタイムアウトを 15 秒に設定
- `cache: false` - キャッシュを無効化してメモリ使用量を削減
- `maxConcurrency: 2` - 並列実行を制限

### 3. メモリ制限の設定

- Node.js のメモリ制限を 4GB に設定
- `NODE_OPTIONS='--max-old-space-size=4096'`

### 4. 重いテストの無効化

- E2E 統合テスト（`e2e-auth-integration.test.tsx`）を一時的に無効化
- エラーハンドリングテストを簡素化

## テスト実行コマンド

### 通常のテスト実行（推奨）

```bash
npm test
```

- メモリ制限: 4GB
- ワーカー数: 2

### 高速テスト実行

```bash
npm run test:fast
```

- メモリ制限: 2GB
- ワーカー数: 1
- 順次実行（runInBand）

### ウォッチモード

```bash
npm run test:watch
```

- メモリ制限: 4GB
- ワーカー数: 1

## テスト時間の目安

- **最適化前**: 500 秒以上（メモリ不足でクラッシュ）
- **最適化後**: 60-120 秒程度

## 今後の改善案

1. **テストの分割**: 大きなテストファイルを複数の小さなファイルに分割
2. **モックの改善**: 重いコンポーネントのモックを追加
3. **並列実行の最適化**: テストの依存関係を減らして並列実行を改善
4. **E2E テストの再有効化**: メモリ使用量を削減してから再有効化

## トラブルシューティング

### メモリ不足エラーが発生する場合

```bash
# メモリ制限を増やす
NODE_OPTIONS='--max-old-space-size=8192' npm test
```

### テストが遅い場合

```bash
# 高速モードで実行
npm run test:fast
```

### 特定のテストファイルのみ実行

```bash
npm test -- src/__tests__/auth-state-properties.test.tsx
```
